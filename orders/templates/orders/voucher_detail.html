{% extends "base.html" %}
{% load static %}
{% block page_header %}
  <div class="text-center my-4">
    <h2 class="service-page heading">Voucher</h2>
    <p class="text-muted mb-0">Show this at check-in to redeem your pupâ€™s service.</p>
  </div>
{% endblock page_header %}
{% block content %}
  <div class="voucher-detail-wrapper">
    <div class="wag-voucher-card">
      <!-- Header bar with status colour -->
      <div class="voucher-header {% if voucher.status == 'ISSUED' %} issued-bg {% elif voucher.status == 'REDEEMED' %} redeemed-bg {% else %} expired-bg {% endif %}">
        <h3 class="heading mb-0">{{ voucher.service.name }}</h3>
      </div>
      <!-- Body -->
      <div class="voucher-body text-center">
        {% url 'orders:redeem_voucher' voucher.code as redeem_path %}
        {% with qr_target=site_root|add:redeem_path %}
          <img src="{% url 'orders:qr' %}?t={{ qr_target|urlencode }}"
               alt="QR Code for voucher {{ voucher.code }}"
               loading="lazy"
               decoding="async"
               class="voucher-qr mb-3">
        {% endwith %}

        <div class="row text-start g-3 mb-3">
          <div class="col-12 col-md-6">
            <p class="mb-1"><strong>Voucher Code:</strong></p>
            <p class="small text-muted">{{ voucher.code }}</p>
          </div>
          <div class="col-12 col-md-6">
            <p class="mb-1"><strong>Status:</strong></p>
            <p class="small text-muted">
              {% if voucher.status == "REDEEMED" and voucher.redeemed_at %}
                Redeemed on {{ voucher.redeemed_at|date:"d M Y, H:i" }}
              {% elif voucher.status == "EXPIRED" %}
                Expired
              {% else %}
                Active
              {% endif %}
            </p>
          </div>
          <div class="col-12 col-md-6">
            <p class="mb-1"><strong>Service:</strong></p>
            <p class="small text-muted">{{ voucher.service }}</p>
          </div>
          <div class="col-12 col-md-6">
            <p class="mb-1"><strong>Customer:</strong></p>
            <p class="small text-muted">{{ voucher.user }}</p>
          </div>
          <div class="col-12 col-md-6">
            <p class="mb-1"><strong>Issued:</strong></p>
            <p class="small text-muted">{{ voucher.issued_at|date:"d M Y" }}</p>
          </div>
          <div class="col-12 col-md-6">
            <p class="mb-1"><strong>Expires:</strong></p>
            <p class="small text-muted">{{ voucher.expires_at|date:"d M Y" }}</p>
          </div>
        </div>

        {% if request.user.is_staff and voucher.status == "ISSUED" %}
          <form method="post" action="{% url 'orders:redeem_voucher' voucher.code %}">
            {% csrf_token %}
            <button class="btn btn-dark mt-2">Redeem Voucher</button>
          </form>
        {% elif voucher.status == "REDEEMED" and voucher.redeemed_at %}
          <p class="text-success mt-2 mb-0">This voucher has already been redeemed.</p>
        {% elif voucher.status == "EXPIRED" %}
          <p class="text-danger mt-2 mb-0">This voucher has expired.</p>
        {% endif %}

        <div class="text-center mt-4 d-flex flex-wrap justify-content-center gap-2">
          <a href="{% url 'orders:my_wallet' %}"
             class="btn btn-outline-secondary">Back to Wallet</a>
          <a href="{% url 'orders:voucher_invoice' voucher.code %}"
             class="btn btn-info">View Invoice</a>
          <button onclick="window.print()" class="btn btn-dark">Print Voucher</button>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
